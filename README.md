# KKTools - 卡卡AI知识库

AI工具、设计资源、学习资料一站式导航平台。

## 🧰 开发环境要求

- Node.js 18 或更高版本
- npm 9 或更高版本
- SQLite（随项目自动创建，无需单独安装）
- PM2（生产部署可选）
- 开发与测试环境：macOS（已验证）

## 📁 项目结构

```
kktools/
├── frontend/              # Next.js 前端应用
│   ├── src/
│   │   ├── app/           # 页面路由
│   │   ├── components/    # React 组件
│   │   ├── hooks/         # 自定义 Hooks
│   │   ├── lib/           # API 和工具函数
│   │   ├── types/         # TypeScript 类型
│   │   └── constants/     # 常量配置
│   ├── public/            # 静态资源
│   └── next.config.js     # Next.js 配置
│
├── backend/               # Express 后端服务
│   ├── server.js         # 主服务器（含高性能缓存系统）
│   ├── db.js             # SQLite 数据库（含索引优化）
│   ├── import-data.js    # 数据导入脚本
│   ├── utils/            # 工具模块
│   └── data/             # 数据库与上传目录
│
├── ecosystem.config.js   # PM2 配置文件
├── package.json          # 根目录脚本
└── README.md
```

## ⚡ 性能优化特性

项目经过深度性能调优，确保在大数据量下依然保持极速响应：

- **数据库加速**：针对资源查询实现了 `idx_resources_composite` 复合索引，消除了查询中的临时排序开销。
- **智能缓存系统**：
  - 后端资源接口采用 **5 分钟长效缓存** (Memory Cache)。
  - **主动失效机制**：当进行资源添加、删除或修改操作时，系统会自动清理受影响分类的缓存，确保数据更新“秒级”同步给用户。
- **图片加载优化**：上传图片默认压缩目标提升至 **10MB**，并支持 WebP 高压格式，在保持画质的同时大幅减少首屏加载流量。
```

## 🚀 快速开始

### 1. 安装依赖

```bash
# 方式一：使用根目录脚本（推荐）
npm run install:all

# 方式二：分别安装
cd backend && npm install
cd ../frontend && npm install
```

### 2. 配置环境变量

#### 后端配置

创建并编辑 `backend/.env`：

```bash
cd backend
cp env.example .env
# 编辑 .env 文件
```

配置项说明（`backend/.env`）：

```env
# 服务器端口
PORT=4200

# 管理员密码哈希（使用 bcrypt 加密）
# 默认密码由数据库初始化为 zhiwen@666（不再使用 admin123）
# 注意：如果通过管理界面修改了密码，数据库中的密码会优先于环境变量
ADMIN_PASSWORD_HASH=REPLACE_WITH_YOUR_BCRYPT_HASH

# 数据库路径（可选，默认 ./data/kktools.db）
# DB_PATH=./data/kktools.db

# 前端开发服务器端口（开发模式，可选）
# FRONTEND_DEV_PORT=3000

# 运行环境（可选，production 或 development）
# NODE_ENV=production

# 日志级别（可选，error/warn/info/debug，默认：生产环境 info，开发环境 debug）
# LOG_LEVEL=info
```

**生成新密码哈希：**

```bash
cd backend
node generate-hash.js your-password
# 将输出的哈希值复制到 .env 的 ADMIN_PASSWORD_HASH
```

#### 前端配置

前端已预置环境变量，通常无需修改：

```env
# 后端 API 地址
NEXT_PUBLIC_API_URL=http://localhost:4200
```


> 💡 **提示**：安装后，每次提交代码时会自动更新README的时间戳。

### 4. 初始化数据（首次运行）

```bash
cd backend
node import-data.js
```

> 💡 **提示**：如果数据库文件已存在，此命令会跳过初始化。如需重新初始化，请先删除 `backend/data/kktools.db` 文件。

### 5. 启动服务

#### 开发模式（统一端口 4200）

```bash
# 方式一：一键启动（推荐）
npm run dev
# 同时启动前端和后端，通过 4200 端口访问

# 方式二：分别启动
# 终端1 - 启动前端开发服务器
npm run dev:frontend

# 终端2 - 启动后端（代理前端）
npm run dev:backend
```

- **统一访问**: http://localhost:4200
- **后端会自动代理前端请求，支持热更新**

#### 生产模式（统一部署，推荐）

```bash
# 1. 构建前端静态文件
npm run build
# 输出到 frontend/out/

# 2. 启动服务（前后端统一）
npm start
# 或使用 PM2
pm2 start ecosystem.config.js
```

- **统一访问**: http://localhost:4200
- **配置管理**: http://localhost:4200/config/

## 📋 常用命令

```bash
# 安装前后端依赖
npm run install:all

# 开发模式（前后端并行）
npm run dev

# 构建前端
npm run build

# 启动统一服务（生产/本地）
npm start
```

### 5. PM2 部署（推荐）

```bash
# 安装 PM2
npm install -g pm2

# 方式一：使用启动脚本（推荐）
cd backend
./start.sh

# 方式二：直接使用 PM2
npm run build
pm2 start ecosystem.config.js

# 常用命令
pm2 status          # 查看状态
pm2 logs kktools     # 查看日志
pm2 monit           # 实时监控面板
pm2 restart kktools # 重启服务
pm2 stop kktools    # 停止服务
pm2 describe kktools # 查看详细信息

# 设置开机自启
pm2 save
pm2 startup
```

> 📖 **详细监控指南**：查看 [MONITORING.md](./MONITORING.md) 了解完整的监控和运维指南

## 🔐 管理员登录

### 默认密码

- **密码**: `zhiwen@666`（已弃用 `admin123`）

### 修改管理员密码

**方式一：通过管理界面（推荐）**

1. 登录管理后台
2. 点击"密码管理"按钮
3. 输入当前密码和新密码
4. 点击"更新密码"
5. 密码立即生效，无需重启服务器

**方式二：通过环境变量**

1. 生成新密码哈希：
   ```bash
   cd backend
   node generate-hash.js your-new-password
   ```

2. 将输出的哈希值更新到 `backend/.env` 的 `ADMIN_PASSWORD_HASH`

3. 重启后端服务

> 💡 **注意**：使用管理界面修改密码后，密码会保存到数据库中，优先于环境变量中的密码。

## ✨ 功能特性

### 前台功能

- 🤖 **AIGC** - AI 工具集合
  - 副标题：探索AI绘画模型和ComfyUI资料集合丨欢迎合作交流微信🛰️XingYueAIArt
  
- 🎨 **UXTips** - UI/UX 设计资源
  - 副标题：跟我学习更多UI/UX知识丨欢迎合作交流微信🛰️XingYueAIArt
  
- 📚 **Learning** - 学习资料（管理员专属）
  - 图标：📄 FileText（文档图标）
  - 副标题：学习资源与教程集合丨欢迎合作交流微信🛰️XingYueAIArt
  
- ⭐ **星芒学社** - 付费内容专区
  - 图标：✨ Sparkles（星星图标）
  - 副标题：愿大家像星星一样散发着光芒，有无限可能
  - **未登录用户**：可以访问，但只能看到 20% 的内容，底部会显示提示信息
  - **已登录用户**：根据密钥的可见度设置（20%、50%、100%）显示对应内容
  - **单设备限制**：每个访问密钥只能在一台设备（IP）上登录，防止多设备同时使用
  - **可见度控制**：管理员可以为每个密钥设置可见度百分比（20%、50%、100%）
    - 用户只能看到对应百分比数量的资源
    - 当可见度不是 100% 时，页面底部会显示提示信息
    - **重要**：可见度设置同时应用于星芒学社和图库两个分类
  
- 🖼️ **图库** - 精选图片资源集合
  - 图标：🖼️ Image（图片图标）
  - 副标题：精选图片资源集合，探索视觉艺术之美
  - **未登录用户**：可以访问但仅 20% 内容；列表卡片展示标题与描述；预览窗口显示提示“登陆后查看描述词”
  - **已登录用户**：根据密钥的可见度设置（20%、50%、100%）显示对应内容
  - **单设备限制**：每个访问密钥只能在一台设备（IP）上登录，防止多设备同时使用
  - **可见度控制**：管理员可以为每个密钥设置可见度百分比（20%、50%、100%）
    - 用户只能看到对应百分比数量的资源
    - 当可见度不是 100% 时，页面底部会显示提示信息
    - **重要**：可见度设置与星芒学社共享，使用相同的百分比设置
  - 支持图片上传和展示
  - 点击图片可以放大查看

### 后台功能（需管理员登录）

- 📝 **资源管理** - 添加、编辑、删除资源卡片
  - 支持链接类型：填写 URL 进行跳转
  - 支持文档类型：直接编写 Markdown 文档，点击卡片弹窗展示
  - **支持图片类型**：上传图片，点击卡片可以放大查看
  - **批量新增**：支持 Excel 批量导入资源（在新增卡片中点击"批量新增"）
    - 下载 Excel 模板
    - 填写资源信息后上传
    - 自动解析和验证数据
    - 支持批量保存多条资源
  - **Learning 分类特殊功能**：编辑资源时可以移动到其他分类（AIGC、UXTips、星芒学社、图库）
  
- 🏷️ **菜单管理** - 管理各分类的过滤菜单（原标签管理）
  - 为每个分类配置过滤菜单项
  - 支持菜单的显示名称和值
  - **导出Excel**：导出当前分类下的所有资源卡片为 Excel 文件
    - 包含完整的资源信息（标题、分类、描述、标签、链接等）
    - 可用于备份或批量编辑
  
- 🔑 **密钥管理** - 生成和管理 星芒学社 访问密钥
  - 设置密钥有效期
  - 设置密钥类型（普通用户/管理员）
  - **星芒学社/图库可见度控制**：设置用户可查看的资源百分比（20%、50%、100%）
    - 20%：用户只能看到前 20% 的资源
    - 50%：用户只能看到前 50% 的资源
    - 100%：用户可以看到所有资源
    - 可见度设置同时应用于星芒学社和图库两个分类
  - 查看所有密钥和使用情况（包括可见度百分比）
  - **复制密钥**：一键复制密钥代码
  - **单设备限制**：每个密钥只能在一台设备上使用，确保安全性
  
- 🔐 **密码管理** - 更改管理员登录密码
  - 验证当前密码
  - 设置新密码（至少6位）
  - 密码实时更新，无需重启服务器
  
- ⚙️ **头部配置** - 自定义 Logo、标题、联系图片、分类副标题
  - 上传头像图片（支持自定义头像）
  - 自定义标题文字
  - 配置合作交流图片
  - **分类副标题配置**：为每个分类Tab配置辅助标题（副标题）
    - 支持配置 AIGC、UXTips、Learning、星芒学社、图库 五个分类的副标题
    - 如果未配置，则使用默认副标题
    - 配置后所有用户都会看到最新的副标题
  - **配置同步**：管理员保存配置后，所有用户（包括未登录访客）都会自动看到最新配置
  - 配置存储在数据库中，确保数据持久化和多设备同步
  - 保存后自动刷新所有打开的页面

### 文档功能（新增）

- 📄 **Markdown 编辑器**
  - 工具栏快捷按钮（标题、粗体、斜体、链接、代码、列表、引用、图片）
  - 快捷键支持（Ctrl+B、Ctrl+I、Ctrl+K 等）
  - 实时字符计数
  - 语法帮助提示
  
- 🖼️ **文档展示**
  - 弹窗展示完整文档内容
  - 支持 Markdown 语法渲染（标题、粗体、斜体、代码、链接、列表、引用、表格、分割线）
  - 图片点击放大查看
  - 响应式设计，支持滚动查看
  
- 🔒 **内容保护**
  - 禁止复制文本
  - 禁止右键菜单
  - 禁止拖拽图片
  - 禁止文本选择

### 交互优化

- 🏠 **Logo 点击返回**
  - 点击头部 Logo/标题自动返回 AIGC 分类
  - 从配置页面点击 Logo 跳转到首页并切换到 AIGC
  
- ✨ **星芒徽标文案**
  - 使用星芒密钥登录时，顶部徽标显示当前身份
  - 普通密钥显示“星芒会员”，管理员密钥显示“星芒管理员”
  
- 🔄 **数据同步**
  - 添加/删除/编辑资源后自动刷新
  - 跨页面数据同步
  - 认证状态变化时自动更新数据

### 权限说明

| 用户类型 | AIGC | UXTips | Learning | 星芒学社 | 图库 |
|---------|------|-------|----------|-----------|------|
| 游客 | ✅ (100%) | ✅ (100%) | ❌ | ✅ (20%) | ✅ (20%) |
| 星芒学社密钥 | ✅ (100%) | ✅ (100%) | ❌ | ✅ (按密钥设置) | ✅ (按密钥设置) |
| 管理员 | ✅ (100%) | ✅ (100%) | ✅ (100%) | ✅ (100%) | ✅ (100%) |

> 💡 **权限说明**：
> - **AIGC 和 UXTips**：所有用户（包括游客）都可以查看全部内容，无需登录
> - **星芒学社和图库**：
>   - **未登录用户**：可以访问，但只能看到 20% 的内容，底部会提示"如需学习更多，请联系管理员卡卡"
>   - **已登录用户**：根据密钥的可见度设置显示内容（20%、50% 或 100%），星芒学社和图库使用相同的可见度设置
>   - **单设备限制**：每个访问密钥只能在一台设备（IP 地址）上登录
>     - 如果密钥已在其他设备上使用，新设备登录会被拒绝
>     - 同一设备可以重新登录（会替换旧的登录状态）
>     - 管理员不受此限制，可以在多台设备上同时登录

## 📝 Markdown 支持

### 支持的语法

- **标题**: `# H1` 到 `###### H6`
- **文本格式**: `**粗体**`、`*斜体*`
- **代码**: `` `行内代码` ``、` ```代码块``` ``
- **链接**: `[文本](URL)`
- **图片**: `![描述](图片URL)` - 点击可放大查看
- **列表**: `- 无序列表`、`1. 有序列表`
- **引用**: `> 引用内容`
- **表格**: Markdown 表格语法
- **分割线**: `---` 或 `***`

### 编辑器功能

- 工具栏快捷按钮
- 快捷键支持
- 实时字符计数
- 语法帮助提示

## 🔧 API 端点

### 认证

- `POST /api/auth/login` - 管理员登录
  - 独立速率限制：1 分钟内最多 10 次登录尝试
  - 不受全局速率限制影响
- `POST /api/auth/verify` - 验证 Token
- `POST /api/auth/logout` - 退出登录
- `POST /api/auth/generate-password-hash` - 生成新密码哈希（需认证）
- `POST /api/auth/update-password` - 更新管理员密码（需认证）
  - 请求体：`{ currentPassword: string, newPassword: string }`
  - 密码会保存到数据库中，优先于环境变量

### 资源

- `GET /api/resources/:category` - 获取分类资源
  - 管理员专属分类（如 Learning）需要认证
- `GET /api/resources` - 获取所有资源
- `POST /api/resources` - 添加/更新资源（需认证）
- `POST /api/resources/batch` - 批量添加资源（需认证）
  - 请求体：`{ resources: Array<Resource> }`
  - 返回详细的成功/失败统计和错误信息
- `DELETE /api/resources/:id` - 删除资源（需认证）

### 过滤器（菜单）

- `GET /api/filters/:category` - 获取分类过滤器
- `POST /api/filters` - 添加过滤器（需认证）
- `DELETE /api/filters/:category/:tag` - 删除过滤器（需认证）

### 访问密钥

- `POST /api/keys/verify` - 验证访问密钥
  - 单设备限制：每个密钥只能在一台设备（IP）上使用
  - 如果密钥已在其他 IP 使用，返回 403 错误
  - 返回密钥信息，包括 `percentage`（星芒学社可见度百分比）
- `GET /api/keys` - 获取所有密钥（需认证）
  - 返回密钥列表，包括 `percentage` 字段
- `POST /api/keys/generate` - 生成新密钥（需认证）
  - 请求体：`{ durationInDays, username, userType, percentage }`
  - `percentage`：星芒学社可见度百分比（20、50 或 100，默认 100）
- `PUT /api/keys/:code` - 重命名密钥（需认证）
- `DELETE /api/keys/:code` - 撤销密钥（需认证）

### 图片上传

- `POST /api/upload/image` - 上传图片（需认证）
  - 使用 multipart/form-data 格式
  - 字段名：`image`
  - 返回图片的完整 URL（包含协议和域名）
  - 图片保存在 `backend/data/uploads/` 目录
  - 支持常见图片格式（jpg, jpeg, png, gif, webp 等）
  - 前端自动将原图压缩为约 20MB 的 JPEG 预览（超大分辨率会按最大边 4096 缩放）
  - 后端允许上传文件最大 25MB（防止压缩后略超限导致失败）

### 头部配置

- `GET /api/config/header` - 获取头部配置（公开）
  - 返回当前配置的头像、标题、图片、分类副标题等信息
  - 所有用户都可以访问，获取最新配置
  - 返回格式：`{ success: boolean, config: { avatar, avatarImage, title, contactImage, cooperationImage, categorySubtitles } }`
- `POST /api/config/header` - 保存头部配置（需管理员认证）
  - 请求体：`{ avatar: string, avatarImage?: string, title: string, contactImage?: string, cooperationImage?: string, categorySubtitles?: { AIGC?: string, UXTips?: string, Learning?: string, '星芒学社'?: string, '图库'?: string } }`
  - `categorySubtitles`：可选，分类副标题配置对象，键为分类名称，值为副标题文本
  - 保存后所有用户都会看到最新配置
  - 配置存储在数据库中

### 健康检查

- `GET /api/health` - 服务器健康状态
  - 包含运行时间、内存使用、数据库状态
  - 包含请求统计信息（总数、成功、错误、慢请求）
  - 包含限流统计和缓存统计
  - 返回状态码：200（健康）、503（降级/不健康）

## 🗄️ 数据库

使用 **better-sqlite3** 存储数据：

- `tokens` - 登录 Token（管理员和 星芒学社 访问）
  - 自动清理过期 Token（每小时）
  - 记录 IP 地址和访问密钥代码（用于单设备限制）
- `access_keys` - 星芒学社 访问密钥
  - `percentage` - 星芒学社可见度百分比（0-100，默认 100）
  - 自动清理过期密钥（每小时）
- `resources` - 资源数据
  - `content_type` - 资源类型（'link'、'document' 或 'image'）
  - `content` - 文档内容（当 content_type 为 'document' 时）或图片URL（当 content_type 为 'image' 时）
- `filters` - 过滤菜单
- `admin_settings` - 管理员设置
  - 存储管理员密码哈希（优先于环境变量）
  - 存储头部配置（头像、标题、图片、分类副标题等）
  - 分类副标题存储键名：`category_subtitle_{分类名}`（如 `category_subtitle_AIGC`）

数据库文件位于 `backend/data/kktools.db`

### 数据备份

建议定期备份数据库文件：

```bash
# 备份数据库
cp backend/data/kktools.db backend/data/kktools.db.backup.$(date +%Y%m%d)

# 恢复数据库
cp backend/data/kktools.db.backup.YYYYMMDD backend/data/kktools.db
```

> ⚠️ **注意**：备份时建议停止服务，确保数据一致性。如果使用 WAL 模式，需要同时备份 `.db-shm` 和 `.db-wal` 文件。

### 数据库特性

- **WAL 模式**：启用 Write-Ahead Logging 提升性能
- **自动索引**：关键字段自动创建索引
  - Token 索引：token、expires_at、access_key_code、ip_address
  - 访问密钥索引：code、expires_at
- **自动清理**：定期清理过期 Token 和访问密钥
- **事务支持**：批量操作使用事务保证数据一致性
- **单设备限制**：通过 IP 地址和访问密钥代码关联实现

## 🚀 后端服务特性

### 性能优化

- **响应压缩**：自动压缩 HTTP 响应，减少传输大小
- **查询缓存**：资源查询结果缓存 30 秒，减少数据库压力
- **请求日志**：结构化日志记录，支持日志级别配置
- **健康检查**：提供详细的服务器健康状态信息
- **数据库优化**：WAL 模式、自动索引、连接池管理
- **内存监控**：自动监控内存使用，超过 80% 发出警告

### 安全性

- **请求限流**：每个 IP 每分钟最多 100 个请求，防止滥用
  - 登录端点独立限流：1 分钟内最多 10 次登录尝试，不受全局限制影响
  - 认证相关端点（登录、验证、密钥验证）跳过全局限流
- **请求超时**：所有请求 30 秒超时保护
- **安全 HTTP 头**：使用 Helmet 设置安全头（生产环境）
- **输入验证**：所有 API 端点都有输入验证
- **统一错误处理**：统一的错误响应格式，生产环境隐藏敏感信息
- **CORS 配置**：灵活的跨域资源共享配置
- **单设备限制**：星芒学社 访问密钥单 IP 登录限制，防止多设备同时使用
- **IP 地址追踪**：记录和验证用户 IP 地址，确保访问安全

### 稳定性

- **全局错误处理**：捕获未处理的异常和 Promise 拒绝，防止进程崩溃
- **数据库连接恢复**：自动检测和恢复数据库连接
- **优雅关闭**：正确处理关闭信号，清理资源
- **自动重启**：PM2 自动重启机制，内存超限自动重启
- **健康检查**：定期检查数据库和系统健康状态

### 可维护性

- **统一日志系统**：支持多级别日志（error/warn/info/debug）
- **模块化设计**：工具模块独立，易于维护和扩展
- **代码组织**：清晰的代码结构和注释
- **监控统计**：请求统计、性能指标、缓存统计

### 新增工具模块

- **logger.js** - 统一日志系统
  - 支持日志级别配置（通过 `LOG_LEVEL` 环境变量）
  - 结构化日志输出
  - 特殊格式支持（请求日志、数据库日志）
  
- **rateLimiter.js** - 优化的限流器
  - 滑动窗口算法
  - 自动清理过期记录
  - 限流统计信息
  
- **cache.js** - 内存缓存系统
  - TTL 支持
  - 自动清理过期缓存
  - 缓存统计信息

## 🌐 生产部署

### 统一部署模式（推荐）

统一部署只需要一个端口，前后端在同一服务中：

```bash
# 1. 构建前端
cd frontend && npm run build

# 2. 启动服务
cd .. && pm2 start ecosystem.config.js
```

### Nginx 反向代理示例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:4200;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 环境变量（生产）

```env
# backend/.env
PORT=4200
ADMIN_PASSWORD_HASH=your-secure-hash
NODE_ENV=production
```

> 💡 **统一部署优势**：
> - 只需要一个端口、一个域名
> - 无跨域问题，无需配置 CORS
> - 简化部署和维护

## 🛠️ 技术栈

### 前端
- **Next.js 14** - App Router, Static Export
- **React 18** - UI 框架
- **TypeScript** - 类型安全
- **Tailwind CSS** - 样式框架
- **Lucide React** - 图标库
- **xlsx** - Excel 文件解析和生成

### 后端
- **Node.js** - 运行时环境
- **Express** - Web 框架
- **better-sqlite3** - SQLite 数据库驱动
- **bcrypt** - 密码加密
- **dotenv** - 环境变量管理
- **compression** - HTTP 响应压缩
- **helmet** - 安全 HTTP 头
- **http-proxy-middleware** - 开发模式代理
- **multer** - 文件上传处理

### 后端工具模块（自研）
- **logger** - 统一日志系统（支持多级别）
- **rateLimiter** - 优化的限流器（滑动窗口）
- **cache** - 内存缓存系统（TTL 支持）

### 开发工具
- **concurrently** - 并发运行多个命令
- **PM2** - 进程管理（生产环境）

## 📦 项目特点

- ✅ **全栈应用** - Next.js 前端 + Express 后端
- ✅ **统一部署** - 前后端同一端口，简化部署
- ✅ **静态导出** - 前端可静态部署
- ✅ **SQLite 数据库** - 轻量级，无需额外数据库服务
- ✅ **Markdown 文档** - 支持富文本文档展示
- ✅ **内容保护** - 文档查看时禁止复制（管理员可复制）
- ✅ **权限控制** - 管理员和访问密钥双重权限
- ✅ **可见度控制** - 支持为密钥设置星芒学社/图库资源可见度百分比（20%、50%、100%），两个分类共享相同设置
- ✅ **分类图标** - 每个分类都有专属彩色 emoji 图标（AIGC: 🤖、UXTips: 🎨、Learning: 📚、星芒学社: ✨、图库: 🖼️）
  - 选中时显示彩色 emoji，未选中时显示单色图标
- ✅ **图片上传** - 支持上传图片资源，点击可放大查看
- ✅ **批量操作** - 支持 Excel 批量导入和导出资源
- ✅ **密码管理** - 支持在线修改管理员密码
- ✅ **密钥管理增强** - 复制密钥、显示可见度、类型管理
- ✅ **头部配置同步** - 管理员保存配置后自动同步到所有用户
- ✅ **分类副标题配置** - 管理员可以为每个分类Tab配置自定义副标题，支持实时同步到所有用户
- ✅ **智能速率限制** - 登录端点独立限流，避免误触发限制
- ✅ **用户体验优化** - 可见度提示、资源限制提示、柔和的hover和选中状态样式
- ✅ **UI设计优化** - 现代化渐变背景、优化间距布局、统一的交互样式
- ✅ **资源移动** - Learning分类的资源可以移动到其他分类
- ✅ **响应式设计** - 适配各种设备
- ✅ **性能优化** - 响应压缩、查询缓存、请求日志、错误处理
- ✅ **安全增强** - 请求限流、超时保护、安全 HTTP 头、输入验证
- ✅ **稳定性保障** - 全局错误处理、数据库连接恢复、优雅关闭
- ✅ **监控完善** - 健康检查、性能统计、日志系统、PM2 监控

## 🎯 使用示例

### 创建链接类型资源

1. 登录管理后台
2. 点击"新增卡片"
3. 选择分类和内容类型为"跳转链接"
4. 填写标题、描述、链接 URL
5. 上传图片
6. 选择菜单标签
7. 保存

### 创建文档类型资源

1. 登录管理后台
2. 点击"新增卡片"
3. 选择分类和内容类型为"文档内容"
4. 填写标题、描述
5. 使用 Markdown 编辑器编写文档内容
   - 使用工具栏按钮快速插入格式
   - 或使用快捷键（Ctrl+B、Ctrl+I 等）
6. 上传封面图片
7. 选择菜单标签
8. 保存

### 创建图片类型资源

1. 登录管理后台
2. 点击"新增卡片"
3. 选择分类和内容类型为"上传图片"
4. 填写标题、描述
5. 上传图片（支持常见图片格式，最大5MB）
   - 图片会自动上传到服务器
   - 上传成功后图片URL会自动填充
6. 选择菜单标签
7. 保存
8. 用户点击卡片时可以放大查看图片

### 批量导入资源

1. 登录管理后台
2. 点击"新增卡片"
3. 点击"批量新增"按钮
4. 点击"下载模板"获取 Excel 模板文件
5. 按照模板格式填写资源信息：
   - **必需列**：标题、分类
   - **可选列**：描述、标签（用逗号分隔）、图片链接、跳转链接、卡卡推荐、内容类型（link/document/image）、文档内容或图片链接
   - **分类值**：必须是 AIGC、UXTips、Learning、星芒学社、图库 之一
6. 上传填写好的 Excel 文件
7. 系统自动解析并显示预览
8. 检查错误提示（如有）
9. 点击"批量保存"完成导入

### 导出资源

1. 登录管理后台
2. 点击"管理菜单"按钮
3. 选择要导出的分类
4. 点击"导出Excel"按钮
5. 系统自动下载包含当前分类所有资源的 Excel 文件
6. 文件名格式：`{分类}_资源列表_{日期}.xlsx`

### 修改管理员密码

1. 登录管理后台
2. 点击"密码管理"按钮
3. 输入当前密码
4. 输入新密码（至少6位）
5. 确认新密码
6. 点击"更新密码"
7. 密码立即生效

### 配置分类副标题

1. 登录管理后台
2. 点击"头部配置"按钮
3. 滚动到"分类副标题配置"部分
4. 为每个分类填写副标题：
   - **AIGC**：如"探索AI绘画模型和ComfyUI资料集合丨欢迎合作交流微信🛰️XingYueAIArt"
   - **UXTips**：如"跟我学习更多UI/UX知识丨欢迎合作交流微信🛰️XingYueAIArt"
   - **Learning**：如"学习资源与教程集合丨欢迎合作交流微信🛰️XingYueAIArt"
   - **星芒学社**：如"愿大家像星星一样散发着光芒，有无限可能"
   - **图库**：如"精选图片资源集合，探索视觉艺术之美"
5. 如果某个分类留空，将使用默认副标题
6. 点击"保存配置"按钮
7. 配置立即生效，所有用户都会看到最新的副标题

### 生成访问密钥（带可见度控制）

1. 登录管理后台
2. 点击"密钥管理"按钮
3. 填写用户名/持有者
4. 选择密钥类型（普通用户/管理员）
5. 设置有效期（天数）
6. **选择星芒学社/图库可见度**（20%、50%、100%）
   - 20%：用户只能看到前 20% 的资源
   - 50%：用户只能看到前 50% 的资源
   - 100%：用户可以看到所有资源
   - 可见度设置同时应用于星芒学社和图库两个分类
7. 点击"生成"按钮
8. 复制生成的密钥代码（点击复制图标）
9. 将密钥分发给用户

### 查看和管理密钥

1. 在密钥管理页面查看所有活跃密钥
2. 每个密钥显示：
   - 密钥代码（可点击复制图标复制）
   - 用户名/持有者（可点击编辑）
   - 密钥类型（普通用户/管理员）
   - 过期时间
   - **星芒学社/图库可见度百分比**
3. 可以撤销密钥（点击删除图标）

### 查看文档

1. 在首页找到文档类型的卡片（右上角有"文档"标识）
2. 点击卡片打开文档弹窗
3. 查看完整文档内容
4. 点击图片可以放大查看
5. 注意：文档内容受保护，无法复制

### 查看图片

1. 在首页找到图片类型的卡片
2. 点击卡片打开图片弹窗
3. 查看完整图片（可放大）
4. 点击关闭按钮或背景区域关闭弹窗

### 移动资源到其他分类（Learning分类）

1. 登录管理后台
2. 选择 Learning 分类
3. 点击要移动的资源进行编辑
4. 在编辑界面找到"移动到其他菜单"下拉选项
5. 选择目标分类（AIGC、UXTips、星芒学社、图库）
6. 点击"保存更改"
7. 资源会自动移动到新分类，并切换到对应的分类tab

## 🔧 开发提示

### 开发模式

开发模式下，后端会自动代理前端请求到 Next.js 开发服务器（端口 3000），支持热更新：

```bash
npm run dev
```

访问 http://localhost:4200 即可，所有请求会自动路由到正确的服务。

### 代码结构优化

项目已进行代码优化，主要改进包括：

- **常量提取**：分类权限、可见度控制等常量统一管理（`frontend/src/constants/index.ts`）
- **工具函数**：权限检查、可见度计算等逻辑封装为可复用函数（`frontend/src/lib/utils.ts`）
- **类型安全**：使用 TypeScript 类型和常量，减少硬编码字符串
- **代码复用**：消除重复逻辑，提高可维护性

主要工具函数：
- `isAdminOnlyCategory()` - 判断是否为管理员专属分类
- `isPercentageControlledCategory()` - 判断是否使用百分比控制
- `getVisibilityPercentage()` - 统一计算可见度百分比

### UI设计优化

项目进行了全面的UI优化，提升用户体验：

- **背景设计**：柔和的渐变背景（#fafbfc → #f6f8fa → #f0f3f6）+ 点状网格图案
- **分类导航**：统一的交互样式，选中状态为白色背景+黑色文字，未选中为透明背景+灰色文字
- **卡片设计**：优化悬停效果，移除黑色描边，使用柔和的阴影和轻微位移
- **间距优化**：统一的间距系统，更舒适的视觉层次
- **动画效果**：流畅的过渡动画（200-300ms），统一的交互反馈

### 数据库文件

数据库文件位于 `backend/data/kktools.db`，包含以下相关文件：
- `kktools.db` - 主数据库文件
- `kktools.db-shm` - 共享内存文件（WAL 模式）
- `kktools.db-wal` - 预写日志文件（WAL 模式）

这些文件都是 SQLite 正常运行所需的，不要手动删除。

### 上传文件

上传的图片保存在 `backend/data/uploads/` 目录，确保该目录有写入权限。

### 常见问题

**Q: 启动后无法访问？**
- 检查端口 4200 是否被占用：`lsof -ti:4200`
- 检查后端日志是否有错误信息
- 确认数据库文件已初始化（运行 `node import-data.js`）

**Q: 前端页面显示空白或错误？**
- 检查浏览器控制台是否有错误
- 确认前端开发服务器正在运行（端口 3000）
- 检查网络请求是否成功（查看 Network 标签）

**Q: 管理员登录失败？**
- 确认密码是否正确（默认：`admin123`）
- 如果修改过密码，确认使用的是新密码
- 检查数据库中是否有管理员密码设置（优先于环境变量）

**Q: 图片上传失败？**
- 检查 `backend/data/uploads/` 目录是否存在且有写入权限
- 确认上传的文件大小不超过限制（默认 5MB）
- 检查文件格式是否支持

**Q: 批量导入 Excel 失败？**
- 确认 Excel 文件格式正确（使用下载的模板）
- 检查必需字段（标题、分类）是否填写
- 查看错误提示信息，修正数据后重新导入

**Q: 如何配置日志级别？**
- 在 `backend/.env` 中设置 `LOG_LEVEL=debug`（可选：error/warn/info/debug）
- 生产环境建议使用 `info`，开发环境使用 `debug`
- 不设置时，生产环境默认 `info`，开发环境默认 `debug`

**Q: 如何查看缓存和限流统计？**
- 访问健康检查端点：`curl http://localhost:4200/api/health | jq`
- 查看 `cache` 字段了解缓存状态
- 查看 `rateLimiter` 字段了解限流状态

**Q: 服务频繁重启？**
- 检查 PM2 日志：`pm2 logs kktools`
- 查看内存使用情况：`pm2 monit`
- 检查数据库连接状态：访问健康检查端点
- 查看错误日志定位问题

## ❓ 故障排除 (Troubleshooting)

### API 端点不存在
**现象**：前端报错 `success":false,"message":"API 端点不存在`
**原因**：这通常是因为前端尝试请求不存在的后端 API，或者是代理配置问题。
**解决方法**：
1. 检查后端 `server.js` 中是否定义了该路由。
2. 确认前端 `.env` 或 `next.config.js` 中的 API URL 配置是否正确。

### Node 模块权限问题
**现象**：启动时出现 `sh: .../node_modules/.bin/concurrently: Permission denied`
**解决方法**：
```bash
chmod -R +x node_modules/.bin
chmod -R +x frontend/node_modules/.bin
```

### Native Module (bcrypt) 兼容性问题
**现象**：后端启动报错 `Error: .../bcrypt/lib/binding/napi-v3/bcrypt_lib.node: invalid ELF header` 或 `mach-o file, but is an incompatible architecture`
**原因**：通常发生在切换 Node 版本或操作系统架构后。
**解决方法**：
```bash
cd backend
npm rebuild bcrypt --build-from-source
# 或者
rm -rf node_modules
npm install
```

### 端口被占用
**现象**：`EADDRINUSE: address already in use :::4200`
**解决方法**：
```bash
lsof -ti:4200 | xargs kill -9
```

## 📚 相关文档

- [监控和运维指南](./MONITORING.md) - 详细的监控、运维和故障排查指南

## 📄 License

MIT

---

最后更新：2026-01-29

## 🆕 最新更新

### 文档与使用说明（2026-01-22）

- 新增开发环境要求（Node.js ≥ 18、npm ≥ 9、PM2 可选）
- 新增常用命令速查（安装、开发、构建、启动、hooks）
- 明确统一访问与配置管理入口地址
- 保持与脚本和钩子一致的时间戳更新说明

### 功能优化和修复（2026-01-18）

- **头部配置优化**：修复了头部配置不生效的问题，确保每次从服务器获取最新配置
- **构建错误修复**：解决了不存在的updatedAt属性引用导致的构建失败
- **UI优化**：
  - 将访问密钥相关字段从居中对齐改为左对齐
  - 移除了星芒学社访问按钮的悬停效果
  - 改进了登录模态框的输入体验
- **服务稳定性**：优化了前后端服务的启动和运行机制

### 分类副标题配置功能（2026-01-14）

新增了分类副标题配置功能，管理员可以为每个分类Tab配置自定义的辅助标题：

- **配置位置**：管理后台 → 头部配置 → 分类副标题配置
- **支持分类**：AIGC、UXTips、Learning、星芒学社、图库
- **功能特点**：
  - 可以为每个分类单独配置副标题
  - 如果未配置，则使用默认副标题
  - 配置后自动同步到所有用户（包括未登录访客）
  - 配置存储在数据库中，确保数据持久化
- **使用场景**：可以根据不同分类的特点，自定义更贴合主题的副标题，提升用户体验
